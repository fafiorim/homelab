# ğŸš€ Pure GitOps Homelab Deployment

This homelab is designed for **pure GitOps deployment** where ArgoCD manages everything from your GitHub repository.

## ğŸ¯ Why This Approach?

**âŒ Problems with Manual `kubectl` Commands:**
- Defeats GitOps principles
- Not reproducible 
- Manual intervention required
- Difficult to troubleshoot

**âœ… Pure GitOps Benefits:**
- **Declarative**: Everything in Git
- **Automated**: ArgoCD handles deployment
- **Self-Healing**: Automatic drift correction
- **Reproducible**: Identical deployments every time
- **Auditable**: All changes tracked in Git

## ğŸ—ï¸ Architecture

```
GitHub Repository (Source of Truth)
    â†“ (GitOps Sync)
ArgoCD (Deployment Engine)
    â†“ (Kubernetes Resources)
Homelab Services
```

### Dependencies Handled

1. **MetalLB** (LoadBalancer) - Bootstrap required for CRDs
2. **Traefik** (Ingress Controller) - Depends on MetalLB
3. **Applications** (Homepage, Grafana, etc.) - Depend on Traefik
4. **Secrets** (Cloudflare Token) - Generated outside Git for security

## ğŸš€ Quick Start

### 1. Prerequisites
- Talos Kubernetes cluster running
- ArgoCD installed and accessible
- Domain in Cloudflare with API token

### 2. Configuration
```bash
# Copy and edit configuration
cp homelab.conf.template homelab.conf
# Edit homelab.conf with your values
```

### 3. One-Command Deployment
```bash
./bootstrap-homelab.sh
```

That's it! ArgoCD will handle the rest.

## ğŸ”§ What the Bootstrap Script Does

### Phase 1: Dependencies (Can't be in ArgoCD)
- âœ… Installs MetalLB CRDs (required before ArgoCD can manage configs)
- âœ… Creates Cloudflare API secret (can't be in Git)
- âœ… Creates required namespaces

### Phase 2: GitOps Deployment
- âœ… Deploys ArgoCD applications pointing to GitHub
- âœ… ArgoCD syncs all manifests automatically
- âœ… Waits for applications to be healthy

### Phase 3: Verification
- âœ… Tests HTTPS endpoints
- âœ… Shows access information
- âœ… Confirms GitOps is active

## ğŸ“ Repository Structure

```
proxmox-talos/
â”œâ”€â”€ bootstrap-homelab.sh     # One-command deployment
â”œâ”€â”€ homelab.conf.template    # Configuration template
â”œâ”€â”€ homelab.conf             # Your configuration (gitignored)
â””â”€â”€ apps/
    â”œâ”€â”€ metallb/            # LoadBalancer (bootstrap required)
    â”‚   â”œâ”€â”€ metallb-app.yaml    # ArgoCD Application
    â”‚   â”œâ”€â”€ config.yaml         # MetalLB config
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ traefik/            # Ingress Controller
    â”‚   â”œâ”€â”€ traefik-app.yaml    # ArgoCD Application
    â”‚   â”œâ”€â”€ deployment.yaml     # Traefik deployment
    â”‚   â”œâ”€â”€ config.yaml         # Traefik config
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ homepage/           # Dashboard
    â”‚   â”œâ”€â”€ homepage-app.yaml   # ArgoCD Application
    â”‚   â”œâ”€â”€ ingress.yaml        # HTTPS routing
    â”‚   â””â”€â”€ ...
    â””â”€â”€ monitoring/         # Prometheus + Grafana
        â”œâ”€â”€ monitoring-app.yaml # ArgoCD Application
        â”œâ”€â”€ ingress.yaml        # HTTPS routing
        â””â”€â”€ ...
```

## ğŸ”„ True GitOps Workflow

### Making Changes
1. **Edit files in GitHub** (via web UI or git push)
2. **ArgoCD detects changes** (every 3 minutes)
3. **Automatic sync** applies changes to cluster
4. **Self-healing** corrects any drift

### No Manual kubectl Required!
- âœ… Add new services â†’ Edit GitHub â†’ ArgoCD deploys
- âœ… Update configurations â†’ Edit GitHub â†’ ArgoCD syncs
- âœ… Scale applications â†’ Edit GitHub â†’ ArgoCD applies
- âœ… Remove services â†’ Delete from GitHub â†’ ArgoCD cleans up

## ğŸ§ª Testing GitOps

### Verify Auto-Sync
```bash
# Make a change in GitHub (e.g., scale homepage replicas)
# Watch ArgoCD detect and apply the change
kubectl get applications -n argocd -w
```

### Test Self-Healing
```bash
# Manually delete a pod
kubectl delete pod -l app=homepage -n homepage

# ArgoCD will recreate it automatically
```

## ğŸ”’ Security

### What's in Git
- âœ… All Kubernetes manifests
- âœ… ArgoCD Application definitions
- âœ… Configuration templates
- âœ… Ingress rules and SSL config

### What's NOT in Git
- âŒ Cloudflare API tokens (generated by bootstrap)
- âŒ TLS certificates (managed by Traefik/Let's Encrypt)
- âŒ Kubernetes secrets with sensitive data

## ğŸ†˜ Troubleshooting

### ArgoCD "Progressing" vs "Healthy"
**Why some apps show "Progressing":**
- âœ… **"Progressing" is often HEALTHY** - means deployment successfully rolled out
- âœ… **Pods running = working** regardless of ArgoCD health status  
- â³ **ArgoCD takes time** to assess complex apps with init containers
- ğŸ” **Check pods directly**: `kubectl get pods -n <namespace>`

### ArgoCD Application Issues
```bash
# Check application status
kubectl get applications -n argocd

# Check actual pod status (more reliable)
kubectl get pods -A | grep -E "(traefik|homepage|grafana)"

# Check specific application
kubectl describe application homepage -n argocd

# Force sync
kubectl patch application homepage -n argocd --type merge -p '{"operation":{"sync":{}}}'
```

### Bootstrap Issues
```bash
# Re-run just bootstrap dependencies
./bootstrap-homelab.sh bootstrap

# Verify configuration
./bootstrap-homelab.sh verify
```

## ğŸ‰ Success Metrics

When everything is working:
- âœ… All ArgoCD applications show "Synced" and "Healthy"
- âœ… All services accessible via HTTPS
- âœ… LoadBalancer IP assigned to Traefik
- âœ… SSL certificates automatically issued
- âœ… Changes to GitHub automatically deployed

## ğŸš€ Next Steps

1. **Add More Services**: Create new directories in `apps/` with ArgoCD applications
2. **Scale Services**: Edit replica counts in GitHub manifests
3. **Update Configurations**: Modify configs in GitHub, ArgoCD will sync
4. **Monitor Changes**: Use ArgoCD UI to watch deployments

**Your homelab is now pure GitOps!** ğŸ¯