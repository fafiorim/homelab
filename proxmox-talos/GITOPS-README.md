# 🚀 Pure GitOps Homelab Deployment

This homelab is designed for **pure GitOps deployment** where ArgoCD manages everything from your GitHub repository.

## 🎯 Why This Approach?

**❌ Problems with Manual `kubectl` Commands:**
- Defeats GitOps principles
- Not reproducible 
- Manual intervention required
- Difficult to troubleshoot

**✅ Pure GitOps Benefits:**
- **Declarative**: Everything in Git
- **Automated**: ArgoCD handles deployment
- **Self-Healing**: Automatic drift correction
- **Reproducible**: Identical deployments every time
- **Auditable**: All changes tracked in Git

## 🏗️ Architecture

```
GitHub Repository (Source of Truth)
    ↓ (GitOps Sync)
ArgoCD (Deployment Engine)
    ↓ (Kubernetes Resources)
Homelab Services
```

### Dependencies Handled

1. **MetalLB** (LoadBalancer) - Bootstrap required for CRDs
2. **Traefik** (Ingress Controller) - Depends on MetalLB
3. **Applications** (Homepage, Grafana, etc.) - Depend on Traefik
4. **Secrets** (Cloudflare Token) - Generated outside Git for security

## 🚀 Quick Start

### 1. Prerequisites
- Talos Kubernetes cluster running
- ArgoCD installed and accessible
- Domain in Cloudflare with API token

### 2. Configuration
```bash
# Copy and edit configuration
cp homelab.conf.template homelab.conf
# Edit homelab.conf with your values
```

### 3. One-Command Deployment
```bash
./bootstrap-homelab.sh
```

That's it! ArgoCD will handle the rest.

## 🔧 What the Bootstrap Script Does

### Phase 1: Dependencies (Can't be in ArgoCD)
- ✅ Installs MetalLB CRDs (required before ArgoCD can manage configs)
- ✅ Creates Cloudflare API secret (can't be in Git)
- ✅ Creates required namespaces

### Phase 2: GitOps Deployment
- ✅ Deploys ArgoCD applications pointing to GitHub
- ✅ ArgoCD syncs all manifests automatically
- ✅ Waits for applications to be healthy

### Phase 3: Verification
- ✅ Tests HTTPS endpoints
- ✅ Shows access information
- ✅ Confirms GitOps is active

## 📁 Repository Structure

```
proxmox-talos/
├── bootstrap-homelab.sh     # One-command deployment
├── homelab.conf.template    # Configuration template
├── homelab.conf             # Your configuration (gitignored)
└── apps/
    ├── metallb/            # LoadBalancer (bootstrap required)
    │   ├── metallb-app.yaml    # ArgoCD Application
    │   ├── config.yaml         # MetalLB config
    │   └── ...
    ├── traefik/            # Ingress Controller
    │   ├── traefik-app.yaml    # ArgoCD Application
    │   ├── deployment.yaml     # Traefik deployment
    │   ├── config.yaml         # Traefik config
    │   └── ...
    ├── homepage/           # Dashboard
    │   ├── homepage-app.yaml   # ArgoCD Application
    │   ├── ingress.yaml        # HTTPS routing
    │   └── ...
    └── monitoring/         # Prometheus + Grafana
        ├── monitoring-app.yaml # ArgoCD Application
        ├── ingress.yaml        # HTTPS routing
        └── ...
```

## 🔄 True GitOps Workflow

### Making Changes
1. **Edit files in GitHub** (via web UI or git push)
2. **ArgoCD detects changes** (every 3 minutes)
3. **Automatic sync** applies changes to cluster
4. **Self-healing** corrects any drift

### No Manual kubectl Required!
- ✅ Add new services → Edit GitHub → ArgoCD deploys
- ✅ Update configurations → Edit GitHub → ArgoCD syncs
- ✅ Scale applications → Edit GitHub → ArgoCD applies
- ✅ Remove services → Delete from GitHub → ArgoCD cleans up

## 🧪 Testing GitOps

### Verify Auto-Sync
```bash
# Make a change in GitHub (e.g., scale homepage replicas)
# Watch ArgoCD detect and apply the change
kubectl get applications -n argocd -w
```

### Test Self-Healing
```bash
# Manually delete a pod
kubectl delete pod -l app=homepage -n homepage

# ArgoCD will recreate it automatically
```

## 🔒 Security

### What's in Git
- ✅ All Kubernetes manifests
- ✅ ArgoCD Application definitions
- ✅ Configuration templates
- ✅ Ingress rules and SSL config

### What's NOT in Git
- ❌ Cloudflare API tokens (generated by bootstrap)
- ❌ TLS certificates (managed by Traefik/Let's Encrypt)
- ❌ Kubernetes secrets with sensitive data

## 🆘 Troubleshooting

### ArgoCD "Progressing" vs "Healthy"
**Why some apps show "Progressing":**
- ✅ **"Progressing" is often HEALTHY** - means deployment successfully rolled out
- ✅ **Pods running = working** regardless of ArgoCD health status  
- ⏳ **ArgoCD takes time** to assess complex apps with init containers
- 🔍 **Check pods directly**: `kubectl get pods -n <namespace>`

### ArgoCD Application Issues
```bash
# Check application status
kubectl get applications -n argocd

# Check actual pod status (more reliable)
kubectl get pods -A | grep -E "(traefik|homepage|grafana)"

# Check specific application
kubectl describe application homepage -n argocd

# Force sync
kubectl patch application homepage -n argocd --type merge -p '{"operation":{"sync":{}}}'
```

### Bootstrap Issues
```bash
# Re-run just bootstrap dependencies
./bootstrap-homelab.sh bootstrap

# Verify configuration
./bootstrap-homelab.sh verify
```

## 🎉 Success Metrics

When everything is working:
- ✅ All ArgoCD applications show "Synced" and "Healthy"
- ✅ All services accessible via HTTPS
- ✅ LoadBalancer IP assigned to Traefik
- ✅ SSL certificates automatically issued
- ✅ Changes to GitHub automatically deployed

## 🚀 Next Steps

1. **Add More Services**: Create new directories in `apps/` with ArgoCD applications
2. **Scale Services**: Edit replica counts in GitHub manifests
3. **Update Configurations**: Modify configs in GitHub, ArgoCD will sync
4. **Monitor Changes**: Use ArgoCD UI to watch deployments

**Your homelab is now pure GitOps!** 🎯